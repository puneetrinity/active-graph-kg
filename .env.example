# ============================================================================
# Active Graph KG - Environment Configuration
# ============================================================================

# ----------------------------------------------------------------------------
# Database Configuration
# ----------------------------------------------------------------------------

# PostgreSQL DSN with pgvector extension
# Format: postgresql://user:password@host:port/database
ACTIVEKG_DSN=postgresql://activekg:activekg@localhost:5432/activekg

# Alternative: Railway/PaaS auto-provision (uses DATABASE_URL if ACTIVEKG_DSN not set)
# DATABASE_URL=postgresql://user:password@host:port/database

# ----------------------------------------------------------------------------
# Row-Level Security (RLS) Configuration
# ----------------------------------------------------------------------------

# RLS mode: auto|on|off (default: auto)
# - auto: Detect database RLS state and set tenant context accordingly (recommended)
# - on: Always set tenant context (use when RLS policies are enabled)
# - off: Skip tenant context (only safe if database RLS is disabled)
#
# Safety: If RLS_MODE=off but database RLS is enabled, the app will force
# tenant context ON to prevent query lockout and log an error.
#
# To disable RLS at database level:
#   psql $ACTIVEKG_DSN -c "ALTER TABLE nodes DISABLE ROW LEVEL SECURITY;"
#   psql $ACTIVEKG_DSN -c "ALTER TABLE edges DISABLE ROW LEVEL SECURITY;"
#   psql $ACTIVEKG_DSN -c "ALTER TABLE events DISABLE ROW LEVEL SECURITY;"
RLS_MODE=auto

# Enable RLS debug logging (shows tenant context in logs)
ACTIVEKG_DEBUG_RLS=false

# ----------------------------------------------------------------------------
# Embedding Configuration
# ----------------------------------------------------------------------------

# Embedding backend: sentence-transformers (default) | openai | cohere
EMBEDDING_BACKEND=sentence-transformers

# Embedding model (384-dim for all-MiniLM-L6-v2)
EMBEDDING_MODEL=all-MiniLM-L6-v2

# Auto-embed on node creation (recommended: true)
AUTO_EMBED_ON_CREATE=true

# ----------------------------------------------------------------------------
# LLM Configuration (for /ask endpoint)
# ----------------------------------------------------------------------------

# LLM backend: groq (default) | openai | litellm
LLM_BACKEND=groq

# LLM model
LLM_MODEL=llama-3.1-8b-instant

# Enable LLM features
LLM_ENABLED=true

# API Keys (set based on backend)
# GROQ_API_KEY=your_groq_key_here
# OPENAI_API_KEY=your_openai_key_here

# /ask endpoint configuration
ASK_SIM_THRESHOLD=0.30        # Minimum similarity for retrieval
ASK_MAX_TOKENS=256            # LLM token budget
ASK_MAX_SNIPPETS=3            # Max context snippets
ASK_SNIPPET_LEN=300           # Characters per snippet

# Reranker configuration
ASK_USE_RERANKER=true         # Enable cross-encoder reranking
RERANK_SKIP_TOPSIM=0.80       # Skip reranking if top similarity >= this

# ----------------------------------------------------------------------------
# Vector Search Configuration
# ----------------------------------------------------------------------------

# Distance metric: cosine (default) | l2 | ip
SEARCH_DISTANCE=cosine

# Vector indexes: ivfflat | hnsw | ivfflat,hnsw (comma-separated for both)
PGVECTOR_INDEXES=ivfflat,hnsw

# IVFFLAT parameters
IVFFLAT_LISTS=100             # Number of inverted lists
IVFFLAT_PROBES=4              # Number of lists to probe

# HNSW parameters (pgvector >= 0.7)
HNSW_M=16                     # Max connections per layer
HNSW_EF_CONSTRUCTION=128      # Build-time search width
HNSW_EF_SEARCH=80             # Query-time search width

# Hybrid search tuning
HYBRID_RERANKER_BASE=20       # Initial candidate pool before rerank
HYBRID_RERANKER_BOOST=45      # Reserved for adaptive boosts
HYBRID_ADAPTIVE_THRESHOLD=0.55 # Log suggestions when low confidence

# ----------------------------------------------------------------------------
# JWT Authentication
# ----------------------------------------------------------------------------

# Enable JWT authentication (recommended for production)
JWT_ENABLED=true

# JWT algorithm: RS256 (production) | HS256 (development)
JWT_ALGORITHM=RS256

# JWT secret key (HS256) or public key (RS256)
# For RS256, set JWT_PUBLIC_KEY to your public key
# JWT_SECRET_KEY=your-32-char-secret-key-here
# JWT_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----\n...\n-----END PUBLIC KEY-----

# JWT validation parameters
JWT_AUDIENCE=activekg
JWT_ISSUER=vantahire            # Must match Vanta JWT issuer claim
JWT_LEEWAY_SECONDS=30           # Clock skew tolerance

# Endpoint scope requirements (for reference):
#   POST /search           => search:read
#   POST /ask, /ask/stream => ask:read
#   POST /nodes, /nodes/batch, /edges, /upload => kg:write
#   POST /admin/*          => admin:refresh

# ----------------------------------------------------------------------------
# Rate Limiting
# ----------------------------------------------------------------------------

# Enable rate limiting (requires Redis)
RATE_LIMIT_ENABLED=true

# Redis URL for rate limiting
REDIS_URL=redis://localhost:6379/0

# ----------------------------------------------------------------------------
# Scheduler Configuration
# ----------------------------------------------------------------------------

# Run scheduler (set to true on exactly ONE instance in multi-instance deployments)
RUN_SCHEDULER=true

# Enable GCS connector polling (set to false to disable, e.g. for testing)
RUN_GCS_POLLER=true

# ----------------------------------------------------------------------------
# Metrics & Observability
# ----------------------------------------------------------------------------

# Enable Prometheus metrics
METRICS_ENABLED=true

# Application version (for metrics)
ACTIVEKG_VERSION=1.0.0

# ----------------------------------------------------------------------------
# Security & Limits
# ----------------------------------------------------------------------------

# Maximum request size (bytes)
MAX_REQUEST_SIZE_BYTES=10485760  # 10MB

# URL allowlist for payload_ref fetching (comma-separated)
# ACTIVEKG_URL_ALLOWLIST=https://example.com,https://api.example.com

# ----------------------------------------------------------------------------
# Connector Configuration
# ----------------------------------------------------------------------------

# GCS credentials (Railway / PaaS): base64-encode your service account JSON
# Generate with: base64 -w0 your-service-account.json
# GOOGLE_CREDENTIALS_B64=eyJ0eXBlIjoic2VydmljZV9hY2NvdW50Ii...

# GCS/S3/Drive connector polling (configured via API)
# See: POST /_admin/connectors/configs

# ----------------------------------------------------------------------------
# Development & Testing
# ----------------------------------------------------------------------------

# Test mode (skips database connection)
ACTIVEKG_TEST_NO_DB=false

# Enable detailed logging
# LOG_LEVEL=DEBUG
